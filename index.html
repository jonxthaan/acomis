<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Acomis</title>
  <!-- AdminLTE CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    .small-box .icon i {
  font-size: 50px; 
  opacity: 0.8;
}
.brand-link {
  padding-left: 30px;
}
  </style>  
</head>
<body class="hold-transition sidebar-mini">

<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="#" class="brand-link">
      <span class="brand-text font-weight-light">ACOMIS</span>
    </a>

    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <li class="nav-item">
            <a href="#" class="nav-link active">
              <i class="nav-icon fas fa-th"></i>
              <p>Salones</p>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Panel de Control</h1>
          </div>
        </div>
      </div>
    </div>

    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <!-- Cards -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-info">
              <div class="inner">
                <h3> Salon </h3>
                <p> 19 </p>
              </div>
              <div class="icon">
                <i class="fa-solid fa-school"></i>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
              <div class="inner">
                <h3><sup style="font-size: 20px">C</sup></h3>
                <p>Temperatura</p>
              </div>
              <div class="icon">
                <i class="fa-solid fa-temperature-low"></i>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-6">
            <div class="small-box bg-warning">
              <div class="inner">
                <h3>0</h3>
                <p>Número de alumnos</p>
              </div>
              <div class="icon">
                <i class="fa-solid fa-person"></i>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-6">
            <div class="small-box bg-danger">
              <div class="inner">
                <h3></h3>
                <p>Hora</p>
              </div>
              <div class="icon">
                <i class="fa-regular fa-clock"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Espacio para imagen -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <!-- El título cambiará dinámicamente a "Estatus ON" o "Estatus OFF" -->
                <h3 class="card-title">Estatus <span id="estatusClima">ON</span></h3>
              </div>
              <div class="card-body text-center">
                <!-- Imagen que ya está definida -->
                <img src="ON.jpg" alt="No pudo cargar la imagen" class="img-fluid" style="max-width: 100%; height: auto;">
              </div>
            </div>
          </div>
        </div>

          <!-- Tabla dinámica -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Tabla de registro</h3>
              </div>
              <div class="card-body">
                <table id="tablaVisitantes" class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>hora</th>
                      <th>personas</th>
                      <th>temperatura</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Datos dinámicos -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAVJAj7nyT7ju7kt6WIHe6wzRsebp6AP9Y",
      authDomain: "acomis-3cc59.firebaseapp.com",
      databaseURL: "https://acomis-3cc59-default-rtdb.firebaseio.com",
      projectId: "acomis-3cc59",
      storageBucket: "acomis-3cc59.firebasestorage.app",
      messagingSenderId: "32579064604",
      appId: "1:32579064604:web:a3c980bdb6fae3d5fba0d9"
    };
  
    // Inicialización de Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Obtener la hora actual en formato HH:MM
    function obtenerHoraActual() {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, "0");
      const minutes = now.getMinutes().toString().padStart(2, "0");
      return `${hours}:${minutes}`;
    }

    // Determinar el estatus del clima basado en la temperatura
    function determinarEstatusClima(temperatura) {
      if (temperatura < 29) {
        return "ON"; // Clima encendido
      } else if (temperatura > 30 ) {
        return "OFF"; // Clima apagado
      } else {
        return "OFF"; // Clima no es necesario
      }
    }

    function escucharRegistros() {
  const registrosRef = db.ref("Registros"); // Ruta de la base de datos en Firebase

  registrosRef.on("value", (snapshot) => {
    const datos = snapshot.val();
    const tablaBody = document.querySelector("#tablaVisitantes tbody");
    tablaBody.innerHTML = ""; // Limpia la tabla antes de agregar datos nuevos

    let ultimaCantidadPersonas = "0"; // Último valor de personas
    let ultimaTemperatura = "Sin temperatura"; // Último valor de temperatura

    if (datos) {
      // Ordenar las claves en orden inverso (del más reciente al más antiguo)
      const claves = Object.keys(datos).reverse();

      claves.forEach((id, index) => {
        const registro = datos[id];

        // Actualizar los valores con los datos más recientes (primer registro en la lista)
        if (index === 0) {
          ultimaCantidadPersonas = registro.personas || "0";
          ultimaTemperatura = registro.temperatura || "Sin temperatura";
        }

        // Agregar la fila a la tabla
        const fila = `
          <tr>
            <td>${registro.hora || "Sin hora"}</td>
            <td>${registro.personas || "0"}</td>
            <td>${registro.temperatura || "Sin temperatura"}</td>
          </tr>
        `;
        tablaBody.innerHTML += fila;
      });
    }

    // Actualizar las tarjetas dinámicamente
    document.querySelector(".small-box.bg-warning .inner h3").innerText = ultimaCantidadPersonas; // Número de alumnos
    document.querySelector(".small-box.bg-success .inner h3").innerText = `${ultimaTemperatura}°C`; // Temperatura
    const horaActual = obtenerHoraActual();
    document.querySelector(".small-box.bg-danger .inner h3").innerText = horaActual; // Hora actual
    const estatusClima = determinarEstatusClima(parseFloat(ultimaTemperatura));
    document.querySelector("#estatusClima").innerText = estatusClima; // Estatus ON/OFF
  });
}



    // Ejecutar la función cuando el DOM esté listo
    document.addEventListener("DOMContentLoaded", () => {
      escucharRegistros();
    });
</script>
</body>
</html>
